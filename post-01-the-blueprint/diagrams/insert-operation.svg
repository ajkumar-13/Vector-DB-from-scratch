<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 750 380">
  <defs>
    <linearGradient id="inputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#748ffc;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#5c7cfa;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ffd43b;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#fab005;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="walGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ff8787;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#fa5252;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#69db7c;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#40c057;stop-opacity:1" />
    </linearGradient>
    <marker id="arrowDark" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#495057"/>
    </marker>
    <marker id="arrowDashed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#868e96"/>
    </marker>
    <filter id="shadowBox" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
  </defs>
  
  <!-- Background -->
  <rect width="750" height="380" fill="#f8f9fa"/>
  
  <!-- Title -->
  <text x="375" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#212529">Insert Operation Flow</text>
  <text x="375" y="48" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#868e96">Upsert Request â†’ WAL â†’ Indexes â†’ Response</text>
  
  <!-- Input Box -->
  <rect x="30" y="80" width="140" height="80" rx="10" fill="url(#inputGrad)" filter="url(#shadowBox)"/>
  <text x="100" y="108" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">ğŸ“¥ Upsert Request</text>
  <text x="100" y="128" text-anchor="middle" font-family="monospace" font-size="9" fill="#c3dafe">{id, vector,</text>
  <text x="100" y="143" text-anchor="middle" font-family="monospace" font-size="9" fill="#c3dafe">metadata}</text>
  
  <!-- Arrow 1 -->
  <line x1="170" y1="120" x2="205" y2="120" stroke="#495057" stroke-width="2" marker-end="url(#arrowDark)"/>
  
  <!-- Step 1: Write to WAL (Critical!) -->
  <rect x="210" y="80" width="140" height="80" rx="10" fill="url(#walGrad)" filter="url(#shadowBox)"/>
  <text x="280" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">1. Write to WAL</text>
  <text x="280" y="125" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#ffe3e3">âš ï¸ FIRST (durability)</text>
  <text x="280" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Append-only log</text>
  
  <!-- Arrow 2 -->
  <line x1="350" y1="120" x2="385" y2="120" stroke="#495057" stroke-width="2" marker-end="url(#arrowDark)"/>
  
  <!-- Step 2: Update Vector Index -->
  <rect x="390" y="70" width="140" height="50" rx="8" fill="#fff9db" stroke="#fcc419" stroke-width="2" filter="url(#shadowBox)"/>
  <text x="460" y="92" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#e67700" font-weight="bold">2. Vector Index</text>
  <text x="460" y="108" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#495057">Update HNSW graph</text>
  
  <!-- Arrow 3 -->
  <line x1="460" y1="120" x2="460" y2="145" stroke="#495057" stroke-width="2" marker-end="url(#arrowDark)"/>
  
  <!-- Step 3: Update Metadata Index -->
  <rect x="390" y="150" width="140" height="50" rx="8" fill="#fff9db" stroke="#fcc419" stroke-width="2" filter="url(#shadowBox)"/>
  <text x="460" y="172" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#e67700" font-weight="bold">3. Metadata Index</text>
  <text x="460" y="188" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#495057">Index attributes</text>
  
  <!-- Arrow 4 -->
  <line x1="530" y1="175" x2="565" y2="175" stroke="#495057" stroke-width="2" marker-end="url(#arrowDark)"/>
  
  <!-- Step 4: Acknowledge -->
  <rect x="570" y="150" width="150" height="50" rx="8" fill="#d3f9d8" stroke="#51cf66" stroke-width="2" filter="url(#shadowBox)"/>
  <text x="645" y="172" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#2b8a3e" font-weight="bold">4. Acknowledge</text>
  <text x="645" y="188" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#495057">âœ“ Return success</text>
  
  <!-- Background Process Section -->
  <rect x="30" y="240" width="690" height="120" rx="10" fill="white" stroke="#dee2e6" stroke-width="1" stroke-dasharray="5,5"/>
  <text x="50" y="265" font-family="Arial, sans-serif" font-size="11" fill="#868e96" font-weight="bold">â±ï¸ Background Process (async)</text>
  
  <!-- Periodic Compaction -->
  <rect x="60" y="285" width="180" height="55" rx="8" fill="#e7f5ff" stroke="#74c0fc" stroke-width="1"/>
  <text x="150" y="308" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#1971c2" font-weight="bold">Periodic Compaction</text>
  <text x="150" y="326" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#495057">When WAL grows large</text>
  
  <!-- Dashed arrow -->
  <line x1="280" y1="175" x2="280" y2="310" stroke="#868e96" stroke-width="1" stroke-dasharray="4,4"/>
  <line x1="240" y1="310" x2="275" y2="310" stroke="#868e96" stroke-width="1" stroke-dasharray="4,4" marker-end="url(#arrowDashed)"/>
  
  <!-- Arrow to segments -->
  <line x1="240" y1="312" x2="315" y2="312" stroke="#868e96" stroke-width="2" marker-end="url(#arrowDark)"/>
  
  <!-- WAL to Segments -->
  <rect x="320" y="285" width="180" height="55" rx="8" fill="url(#bgGrad)" filter="url(#shadowBox)"/>
  <text x="410" y="308" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="white" font-weight="bold">WAL â†’ Segments</text>
  <text x="410" y="326" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#ebfbee">Memory-mapped files</text>
  
  <!-- Arrow to disk -->
  <line x1="500" y1="312" x2="535" y2="312" stroke="#495057" stroke-width="2" marker-end="url(#arrowDark)"/>
  
  <!-- Disk -->
  <rect x="540" y="285" width="160" height="55" rx="8" fill="#f1f3f5" stroke="#ced4da" stroke-width="2"/>
  <text x="620" y="308" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#495057" font-weight="bold">ğŸ’¾ Disk</text>
  <text x="620" y="326" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#868e96">Optimized binary files</text>
</svg>
